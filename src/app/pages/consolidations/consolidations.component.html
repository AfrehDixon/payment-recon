<div class="consolidations-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>Consolidations</h1>

      <!-- Bulk Actions Bar -->
      <div class="bulk-actions-bar" *ngIf="selectedConsolidations.size > 0">
        <div class="selection-info">
          <span class="selected-count">{{ selectedConsolidations.size }} item{{ selectedConsolidations.size !== 1 ? 's' : '' }} selected</span>
          <button class="clear-selection-btn" (click)="clearSelection()" title="Clear Selection">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
            Clear
          </button>
        </div>

        <div class="bulk-action-buttons">
          <button class="export-excel-btn" (click)="exportSelectedToExcel()" [disabled]="selectedConsolidations.size === 0" title="Export Selected to Excel">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
              <polyline points="14,2 14,8 20,8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
            </svg>
            Export to Excel
          </button>
        </div>
      </div>

      <!-- Search and Filter Section -->
      <div class="search-section">
        <div class="search-box">
          <svg class="search-icon" viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          <input type="text" placeholder="Search by ID, transaction ID, or address..." (keyup)="onSearchChange($event)" class="search-input" />
        </div>

        <div class="filters">
          <select [(ngModel)]="operatorFilter" (change)="onFilterChange()" class="filter-select">
            <option value="">All Operators</option>
            <option *ngFor="let operator of operators" [value]="operator">{{ operator }}</option>
          </select>

          <select [(ngModel)]="statusFilter" (change)="onFilterChange()" class="filter-select">
            <option value="">All Statuses</option>
            <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
          </select>

          <select [(ngModel)]="chainFilter" (change)="onFilterChange()" class="filter-select">
            <option value="">All Chains</option>
            <option *ngFor="let chain of chains" [value]="chain">{{ chain }}</option>
          </select>

          <input type="date" [(ngModel)]="dateFrom" (change)="onFilterChange()" class="date-input" title="From Date" />
          <input type="date" [(ngModel)]="dateTo" (change)="onFilterChange()" class="date-input" title="To Date" />
        </div>

        <div class="consolidations-count" *ngIf="!loading">
          {{ filteredConsolidations.length }} consolidation{{ filteredConsolidations.length !== 1 ? 's' : '' }}
        </div>

        <div class="action-buttons">
          <button class="stats-btn" (click)="loadStats()" [disabled]="loading" title="View Stats">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
              <line x1="12" y1="20" x2="12" y2="10" />
              <line x1="18" y1="20" x2="18" y2="4" />
              <line x1="6" y1="20" x2="6" y2="16" />
            </svg>
            Stats
          </button>

          <button class="refresh-btn" (click)="loadConsolidations()" [disabled]="loading" title="Refresh">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
              <path d="M4 4v5h.582M20 20v-5h-.581M5.07 19A9 9 0 1 1 19 5.07" />
            </svg>
            <span *ngIf="!loading">Refresh</span>
            <span *ngIf="loading">
              <div class="mini-spinner"></div>
              Loading...
            </span>
          </button>

          <button class="export-all-btn" (click)="exportAllToExcel()" [disabled]="loading || filteredConsolidations.length === 0" title="Export All to Excel">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
              <polyline points="14,2 14,8 20,8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
            </svg>
            Export All
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    {{ error }}
    <button class="close-btn" (click)="error = null">&times;</button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner"></div>
    <span>Loading consolidations...</span>
  </div>

  <!-- Consolidations Table -->
  <div class="table-container" *ngIf="!loading && consolidations.length > 0">
    <table class="consolidations-table">
      <thead>
        <tr>
          <th class="checkbox-column">
            <label class="checkbox-wrapper">
              <input type="checkbox" [checked]="isAllSelected" [indeterminate]="selectedConsolidations.size > 0 && !isAllSelected" (change)="toggleSelectAll()" />
              <span class="checkmark"></span>
            </label>
          </th>
          <th (click)="changeSort('_id')" class="sortable">
            ID
            <span class="sort-indicator" *ngIf="sortBy === '_id'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span>
          </th>
          <th (click)="changeSort('operator')" class="sortable">
            Operator
            <span class="sort-indicator" *ngIf="sortBy === 'operator'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span>
          </th>
          <th (click)="changeSort('status')" class="sortable">
            Status
            <span class="sort-indicator" *ngIf="sortBy === 'status'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span>
          </th>
          <th>Direction</th>
          <th>Inbound</th>
          <th>Outbound</th>
          <th>Fees</th>
          <th (click)="changeSort('createdAt')" class="sortable">
            Created
            <span class="sort-indicator" *ngIf="sortBy === 'createdAt'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span>
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let consolidation of filteredConsolidations" class="table-row">
          <td class="checkbox-column">
            <label class="checkbox-wrapper">
              <input type="checkbox" [checked]="isConsolidationSelected(consolidation._id)" (change)="toggleConsolidationSelection(consolidation._id)" />
              <span class="checkmark"></span>
            </label>
          </td>
          <td class="consolidation-id">
            <span class="id-short" [title]="consolidation._id">{{ consolidation._id.slice(-8) }}</span>
            <span class="lock-indicator" *ngIf="consolidation.lock" title="Locked by {{ consolidation.lockBy }}">ðŸ”’</span>
          </td>
          <td class="operator">{{ consolidation.operator }}</td>
          <td>
            <span [class]="'status-badge ' + getStatusClass(consolidation.status)">
              {{ consolidation.status }}
            </span>
          </td>
          <td class="direction">
            <span *ngIf="consolidation.direction" [class]="'direction-badge'">{{ consolidation.direction }}</span>
            <span *ngIf="consolidation.context?.type" [class]="'context-badge ' + getContextTypeClass(consolidation.context?.type ?? '')">
              {{ consolidation.context?.type }}
            </span>
          </td>
          <td class="chain-info">
            <div class="chain-row">
              <span class="chain">{{ consolidation.inbound.chain }}</span>
              <span class="asset">{{ consolidation.inbound.asset }}</span>
            </div>
            <div class="amount" *ngIf="consolidation.inbound.amountHuman">{{ consolidation.inbound.amountHuman }}</div>
            <div class="confirmations" *ngIf="consolidation.inbound.confirmations !== undefined">
              <span [class]="'conf-badge conf-' + getConfirmationStatus(consolidation.inbound.confirmations)">
                {{ consolidation.inbound.confirmations }} conf
              </span>
            </div>
          </td>
          <td class="chain-info">
            <div *ngIf="consolidation.outbound" class="chain-row">
              <span class="chain">{{ consolidation.outbound.chain }}</span>
              <span class="asset">{{ consolidation.outbound.asset }}</span>
            </div>
            <div class="amount" *ngIf="consolidation.outbound?.amountHuman">{{ consolidation.outbound?.amountHuman }}</div>
            <div class="confirmations" *ngIf="consolidation.outbound?.confirmations !== undefined">
              <span [class]="'conf-badge conf-' + getConfirmationStatus(consolidation.outbound?.confirmations)">
                {{ consolidation.outbound?.confirmations }} conf
              </span>
            </div>
            <span *ngIf="!consolidation.outbound" class="no-data">-</span>
          </td>
          <td class="fees">
            <div *ngIf="getTotalFeeUsd(consolidation) > 0" class="fee-amount">
              {{ formatCurrency(getTotalFeeUsd(consolidation)) }}
            </div>
            <span *ngIf="getTotalFeeUsd(consolidation) === 0" class="no-data">-</span>
          </td>
          <td class="date">{{ formatDate(consolidation.createdAt) }}</td>
          <td class="actions">
            <div class="action-buttons">
              <button class="action-btn view-btn" (click)="openDetailsModal(consolidation)" title="View Details">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="!loading && totalPages > 1">
    <div class="pagination-info">
      Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ Math.min(currentPage * pageSize, totalItems) }} of {{ totalItems }} entries
    </div>

    <div class="pagination-controls">
      <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(1)" title="First Page">Â«Â«</button>
      <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)" title="Previous Page">â€¹</button>

      <span class="page-numbers">
        <button *ngFor="let page of getPageNumbers()" class="page-btn" [class.active]="page === currentPage" (click)="isNumber(page) ? changePage(page) : null" [disabled]="page === '...'">
          {{ page }}
        </button>
      </span>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)" title="Next Page">â€º</button>
      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(totalPages)" title="Last Page">Â»Â»</button>
    </div>

    <div class="page-size-selector">
      <label>Show:</label>
      <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span>entries</span>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && consolidations.length === 0" class="empty-state">
    <svg viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" fill="none">
      <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
      <polyline points="7.5,15 12,17.5 16.5,15" />
      <polyline points="7.5,9 12,6.5 16.5,9" />
    </svg>
    <p>No consolidations found. Check your filters or try refreshing.</p>
  </div>

  <!-- Details Modal -->
  <div class="modal" *ngIf="showDetailsModal">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h2>Consolidation Details</h2>
        <button class="close-btn" (click)="closeDetailsModal()">&times;</button>
      </div>

      <div *ngIf="selectedConsolidation" class="details-content">
        <!-- Basic Information -->
        <div class="details-section">
          <h3>Basic Information</h3>
          <div class="details-grid">
            <div class="detail-item">
              <label>ID</label>
              <span class="monospace">{{ selectedConsolidation._id }}</span>
            </div>
            <div class="detail-item">
              <label>Operator</label>
              <span>{{ selectedConsolidation.operator }}</span>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <span [class]="'status-text ' + getStatusClass(selectedConsolidation.status)">{{ selectedConsolidation.status }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.direction">
              <label>Direction</label>
              <span>{{ selectedConsolidation.direction }}</span>
            </div>
            <div class="detail-item">
              <label>Created At</label>
              <span>{{ formatDate(selectedConsolidation.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <label>Updated At</label>
              <span>{{ formatDate(selectedConsolidation.updatedAt) }}</span>
            </div>
          </div>
        </div>

        <!-- Context Information -->
        <div class="details-section" *ngIf="selectedConsolidation.context">
          <h3>Context</h3>
          <div class="details-grid">
            <div class="detail-item" *ngIf="selectedConsolidation.context.type">
              <label>Type</label>
              <span [class]="'context-text ' + getContextTypeClass(selectedConsolidation.context.type)">{{ selectedConsolidation.context.type }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.context.relatedTransactionId">
              <label>Related Transaction</label>
              <span class="monospace">{{ selectedConsolidation.context.relatedTransactionId }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.context.merchantId">
              <label>Merchant ID</label>
              <span class="monospace">{{ selectedConsolidation.context.merchantId }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.context.note">
              <label>Note</label>
              <span>{{ selectedConsolidation.context.note }}</span>
            </div>
          </div>
        </div>

        <!-- Inbound Details -->
        <div class="details-section">
          <h3>Inbound Transaction</h3>
          <div class="details-grid">
            <div class="detail-item">
              <label>Chain</label>
              <span class="chain-badge">{{ selectedConsolidation.inbound.chain }}</span>
            </div>
            <div class="detail-item">
              <label>Asset</label>
              <span class="asset-badge">{{ selectedConsolidation.inbound.asset }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.address">
              <label>Address</label>
              <span class="monospace address">{{ selectedConsolidation.inbound.address }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.txid">
              <label>Transaction ID</label>
              <span class="monospace txid">{{ selectedConsolidation.inbound.txid }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.amountHuman">
              <label>Amount (Human)</label>
              <span class="amount-large">{{ selectedConsolidation.inbound.amountHuman }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.amountBase">
              <label>Amount (Base)</label>
              <span class="monospace">{{ selectedConsolidation.inbound.amountBase }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.decimals">
              <label>Decimals</label>
              <span>{{ selectedConsolidation.inbound.decimals }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.confirmations !== undefined">
              <label>Confirmations</label>
              <span [class]="'conf-badge conf-' + getConfirmationStatus(selectedConsolidation.inbound.confirmations)">
                {{ selectedConsolidation.inbound.confirmations }}
              </span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.inbound.observedAt">
              <label>Observed At</label>
              <span>{{ formatDate(selectedConsolidation.inbound.observedAt) }}</span>
            </div>
          </div>
        </div>

        <!-- Outbound Details -->
        <div class="details-section" *ngIf="selectedConsolidation.outbound">
          <h3>Outbound Transaction</h3>
          <div class="details-grid">
            <div class="detail-item">
              <label>Chain</label>
              <span class="chain-badge">{{ selectedConsolidation.outbound.chain }}</span>
            </div>
            <div class="detail-item">
              <label>Asset</label>
              <span class="asset-badge">{{ selectedConsolidation.outbound.asset }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.outbound.address">
              <label>Address</label>
              <span class="monospace address">{{ selectedConsolidation.outbound.address }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.outbound.txid">
              <label>Transaction ID</label>
              <span class="monospace txid">{{ selectedConsolidation.outbound.txid }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.outbound.amountHuman">
              <label>Amount (Human)</label>
              <span class="amount-large">{{ selectedConsolidation.outbound.amountHuman }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.outbound.amountBase">
              <label>Amount (Base)</label>
              <span class="monospace">{{ selectedConsolidation.outbound.amountBase }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.outbound.confirmations !== undefined">
              <label>Confirmations</label>
              <span [class]="'conf-badge conf-' + getConfirmationStatus(selectedConsolidation.outbound.confirmations)">
                {{ selectedConsolidation.outbound.confirmations }}
              </span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.outbound.observedAt">
              <label>Observed At</label>
              <span>{{ formatDate(selectedConsolidation.outbound.observedAt) }}</span>
            </div>
          </div>
        </div>

        <!-- Quote Information -->
        <div class="details-section" *ngIf="selectedConsolidation.quote">
          <h3>Quote Information</h3>
          <div class="details-grid">
            <div class="detail-item" *ngIf="selectedConsolidation.quote.source">
              <label>Source</label>
              <span class="source-badge">{{ selectedConsolidation.quote.source }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.quote.expectedOutBase">
              <label>Expected Out (Base)</label>
              <span class="monospace">{{ selectedConsolidation.quote.expectedOutBase }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.quote.minOutBase">
              <label>Min Out (Base)</label>
              <span class="monospace">{{ selectedConsolidation.quote.minOutBase }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.quote.slippageBps">
              <label>Slippage (BPS)</label>
              <span>{{ selectedConsolidation.quote.slippageBps }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.quote.expiry">
              <label>Expiry</label>
              <span>{{ getQuoteExpiryDate(selectedConsolidation) }}</span>
            </div>
          </div>
        </div>

        <!-- Fee Information -->
        <div class="details-section" *ngIf="selectedConsolidation.fees && getTotalFeeUsd(selectedConsolidation) > 0">
          <h3>Fee Breakdown</h3>
          <div class="details-grid">
            <div class="detail-item" *ngIf="selectedConsolidation.fees.networkFeeUsd">
              <label>Network Fee</label>
              <span class="fee-amount">{{ formatCurrency(selectedConsolidation.fees.networkFeeUsd) }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.fees.protocolFeeUsd">
              <label>Protocol Fee</label>
              <span class="fee-amount">{{ formatCurrency(selectedConsolidation.fees.protocolFeeUsd) }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.fees.serviceFeeUsd">
              <label>Service Fee</label>
              <span class="fee-amount">{{ formatCurrency(selectedConsolidation.fees.serviceFeeUsd) }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.fees.totalFeeUsd">
              <label>Total Fee</label>
              <span class="fee-amount total-fee">{{ formatCurrency(selectedConsolidation.fees.totalFeeUsd) }}</span>
            </div>
          </div>
        </div>

        <!-- Error Information -->
        <div class="details-section" *ngIf="selectedConsolidation.errorMessage || selectedConsolidation.attempts">
          <h3>Error Information</h3>
          <div class="details-grid">
            <div class="detail-item" *ngIf="selectedConsolidation.errorMessage">
              <label>Error Message</label>
              <span class="error-text">{{ selectedConsolidation.errorMessage }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.attempts">
              <label>Attempts</label>
              <span class="attempts-count">{{ selectedConsolidation.attempts }}</span>
            </div>
          </div>
        </div>

        <!-- Lock Information -->
        <div class="details-section" *ngIf="selectedConsolidation.lock">
          <h3>Lock Information</h3>
          <div class="details-grid">
            <div class="detail-item">
              <label>Locked</label>
              <span class="lock-status">Yes</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.lockBy">
              <label>Locked By</label>
              <span>{{ selectedConsolidation.lockBy }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedConsolidation.lockAt">
              <label>Locked At</label>
              <span>{{ formatDate(selectedConsolidation.lockAt) }}</span>
            </div>
          </div>
        </div>

        <!-- Additional Timestamps -->
        <div class="details-section" *ngIf="selectedConsolidation.lastPolledAt">
          <h3>Additional Information</h3>
          <div class="details-grid">
            <div class="detail-item">
              <label>Last Polled</label>
              <span>{{ formatDate(selectedConsolidation.lastPolledAt) }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeDetailsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div class="modal" *ngIf="showStatsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Consolidation Statistics</h2>
        <button class="close-btn" (click)="closeStatsModal()">&times;</button>
      </div>

      <div class="stats-content">
        <div class="stats-grid">
          <div *ngFor="let stat of statsData" class="stat-item">
            <div class="stat-header">
              <span class="operator">{{ stat.operator }}</span>
              <span [class]="'status-badge ' + getStatusClass(stat.status)">{{ stat.status }}</span>
            </div>
            <div class="stat-count">{{ stat.count }}</div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeStatsModal()">Close</button>
      </div>
    </div>
  </div>
</div>